name: VIDEO EDITING COMBINED (WITH COUNTER)

on:
  workflow_dispatch:
  # schedule:
    # - cron: '30 18 * * *'   # 12:00 AM IST (6:30 PM UTC previous day)
    # - cron: '30 22 * * *'   # 4:00 AM IST (10:30 PM UTC previous day)
    # - cron: '30 2 * * *'    # 8:00 AM IST (2:30 AM UTC)
    # - cron: '30 6 * * *'    # 12:00 PM IST (6:30 AM UTC)
    # - cron: '30 10 * * *'   # 4:00 PM IST (10:30 AM UTC)

jobs:
  update-counter:
    runs-on: ubuntu-latest
    outputs:
      video_number: ${{ steps.increment.outputs.video_number }}
    steps:
      # Checkout repository
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          repository: WildlifeAnimalDocumentaries/wildlife.animal.documentaries
          token: ${{ secrets.PRIVATE_REPO_TOKEN }}
          sparse-checkout: |
            counter_video_editing.py
            counter_video_editing.txt
            video_end_tracker.txt
          fetch-depth: 1

      # Set up Python for counter scripts
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12.9'

      # Increment video editing counter
      - name: Increment Counter
        id: increment
        run: |
          python3 counter_video_editing.py
          VIDEO_NUMBER=$(cat counter_video_editing.txt)
          echo "video_number=$VIDEO_NUMBER" >> $GITHUB_OUTPUT
          echo "Updated video editing counter to: $VIDEO_NUMBER"

      # Commit updated counter file
      - name: Commit Counter Update
        run: |
          git config --local user.name "github-actions"
          git config --local user.email "github-actions@github.com"
          git add counter_video_editing.txt
          git commit -m "Update video editing counter" || echo "No changes to commit"
          git pull --rebase origin main || echo "No changes to pull"
          git push || echo "No changes to push"

  run-on-kaggle:
    needs: update-counter
    runs-on: ubuntu-latest
    steps:
      # Checkout repository
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          repository: WildlifeAnimalDocumentaries/wildlife.animal.documentaries
          token: ${{ secrets.PRIVATE_REPO_TOKEN }}
          sparse-checkout: |
            IPNBY/quality.ipynb
            VIDEO_EDITING_QUALITY/
            AI_MODELS/
            counter_video_editing.txt
            video_end_tracker.txt
            requirements.txt
            kaggle_account_tracker.txt
          fetch-depth: 1

      # Pull latest changes (includes updated counter)
      - name: Pull Latest Changes
        run: |
          git pull origin main

      # Read current Kaggle account number
      - name: Read Kaggle Account Number
        id: read_kaggle_account
        run: |
          ACCOUNT_NUM=$(cat kaggle_account_tracker.txt)
          echo "account_number=$ACCOUNT_NUM" >> $GITHUB_OUTPUT
          echo "ðŸ“Œ Current Kaggle account number: $ACCOUNT_NUM"

      # Set Kaggle credentials based on account number
      - name: Set Kaggle Credentials
        id: set_kaggle_creds
        run: |
          ACCOUNT_NUM=${{ steps.read_kaggle_account.outputs.account_number }}
          
          # Dynamically get the username and key from secrets based on account number
          case $ACCOUNT_NUM in
            1)
              KAGGLE_USERNAME="${{ secrets.KAGGLE_USERNAME_1 }}"
              KAGGLE_KEY="${{ secrets.KAGGLE_KEY_1 }}"
              ;;
            2)
              KAGGLE_USERNAME="${{ secrets.KAGGLE_USERNAME_2 }}"
              KAGGLE_KEY="${{ secrets.KAGGLE_KEY_2 }}"
              ;;
            3)
              KAGGLE_USERNAME="${{ secrets.KAGGLE_USERNAME_3 }}"
              KAGGLE_KEY="${{ secrets.KAGGLE_KEY_3 }}"
              ;;
            *)
              echo "âŒ Invalid account number: $ACCOUNT_NUM"
              exit 1
              ;;
          esac
          
          echo "kaggle_username=$KAGGLE_USERNAME" >> $GITHUB_OUTPUT
          echo "kaggle_key=$KAGGLE_KEY" >> $GITHUB_OUTPUT
          echo "âœ… Using Kaggle credentials for account $ACCOUNT_NUM"
          echo "ðŸ“ Kaggle Username: $KAGGLE_USERNAME"

      # Configure Sparse Checkout for specific video
      - name: Configure Sparse Checkout
        run: |
          VIDEO_NUMBER="${{ needs.update-counter.outputs.video_number }}"
          echo "Processing Video_${VIDEO_NUMBER}.mp4"
          echo "VIDEOS/Video_${VIDEO_NUMBER}.mp4" >> .git/info/sparse-checkout
          echo "REELS/test.mp4" >> .git/info/sparse-checkout
          git sparse-checkout reapply

      # Install Kaggle API
      - name: Install Kaggle API
        run: pip install kaggle

      # Configure Kaggle with credentials
      - name: Configure Kaggle
        run: |
          mkdir -p ~/.kaggle
          KAGGLE_USERNAME="${{ steps.set_kaggle_creds.outputs.kaggle_username }}"
          KAGGLE_KEY="${{ steps.set_kaggle_creds.outputs.kaggle_key }}"
          echo "{\"username\":\"$KAGGLE_USERNAME\",\"key\":\"$KAGGLE_KEY\"}" > ~/.kaggle/kaggle.json
          chmod 600 ~/.kaggle/kaggle.json
          echo "ðŸ”§ Configured Kaggle credentials"
          echo "ðŸ“ Kaggle Username: $KAGGLE_USERNAME"

      # Prepare Dataset Folder
      - name: Prepare Dataset Folder
        run: |
          mkdir -p kaggle-dataset
          cp -r REELS kaggle-dataset/ || true
          cp -r VIDEO_EDITING_QUALITY kaggle-dataset/ || true
          cp -r AI_MODELS kaggle-dataset/ || true
          cp counter_video_editing.txt kaggle-dataset/ || true
          cp video_end_tracker.txt kaggle-dataset/ || true
          cp requirements.txt kaggle-dataset/ || true
          cp IPNBY/quality.ipynb kaggle-dataset/
          
          # Include the sparse-checked video file
          VIDEO_NUMBER="${{ needs.update-counter.outputs.video_number }}"
          mkdir -p kaggle-dataset/VIDEOS
          cp "VIDEOS/Video_${VIDEO_NUMBER}.mp4" kaggle-dataset/VIDEOS/ || echo "âš ï¸ Video file not found: VIDEOS/Video_${VIDEO_NUMBER}.mp4"

          # Kaggle dataset metadata
          KAGGLE_USERNAME="${{ steps.set_kaggle_creds.outputs.kaggle_username }}"
          cat > kaggle-dataset/dataset-metadata.json <<EOF
          {
            "id": "$KAGGLE_USERNAME/video-editing-data",
            "title": "Video Editing Data",
            "licenses": [
              { "name": "CC0-1.0" }
            ],
            "isPrivate": true
          }
          EOF

      # Create or Update Kaggle Dataset
      - name: Create or Update Kaggle Dataset
        run: |
          KAGGLE_USERNAME="${{ steps.set_kaggle_creds.outputs.kaggle_username }}"
          for i in $(seq 1 5); do
            if kaggle datasets status $KAGGLE_USERNAME/video-editing-data >/dev/null 2>&1; then
              echo "âœ… Dataset exists, versioning... (Attempt $i)"
              if kaggle datasets version -p kaggle-dataset -m "Update dataset for run" --dir-mode zip; then
                echo "âœ… Versioning successful"
                break
              fi
            else
              echo "âš¡ Dataset not found, creating... (Attempt $i)"
              if kaggle datasets create -p kaggle-dataset --dir-mode zip; then
                echo "âœ… Creation successful"
                break
              fi
            fi
            
            if [ $i -lt 5 ]; then
              echo "âš ï¸ Command failed. Retrying in 30 seconds..."
              sleep 30
            else
              echo "âŒ Command failed after 5 attempts."
              exit 1
            fi
          done

      # List datasets
      - name: List Datasets
        run: |
          KAGGLE_USERNAME="${{ steps.set_kaggle_creds.outputs.kaggle_username }}"
          echo "ðŸ“¦ Listing datasets for user: $KAGGLE_USERNAME"
          sleep 60
          kaggle datasets list --user $KAGGLE_USERNAME

      # Prepare Kernel Metadata
      - name: Prepare Kernel Metadata
        run: |
          KAGGLE_USERNAME="${{ steps.set_kaggle_creds.outputs.kaggle_username }}"
          cat > kernel-metadata.json <<EOF
          {
            "id": "$KAGGLE_USERNAME/video-editing-scheduler-notebook",
            "title": "Video Editing Scheduler Notebook",
            "code_file": "IPNBY/quality.ipynb",
            "language": "python",
            "kernel_type": "notebook",
            "is_private": true,
            "enable_gpu": true,
            "enable_internet": true,
            "dataset_sources": [
              "$KAGGLE_USERNAME/video-editing-data"
            ],
            "competition_sources": [],
            "kernel_sources": [],
            "model_sources": []
          }
          EOF

      # Push Notebook to Kaggle
      - name: Push Notebook to Kaggle
        run: kaggle kernels push -p .

      # Wait for Kaggle Notebook to Finish
      - name: Wait for Kaggle Notebook to Finish
        run: |
          KAGGLE_USERNAME="${{ steps.set_kaggle_creds.outputs.kaggle_username }}"
          KERNEL_ID="$KAGGLE_USERNAME/video-editing-scheduler-notebook"
          for i in $(seq 1 600); do
            STATUS=$(kaggle kernels status $KERNEL_ID)
            echo "[$i] Status: $STATUS"
            if [[ "$STATUS" == *"KernelWorkerStatus.COMPLETE"* ]]; then
              echo "âœ… Kernel Complete"
              exit 0
            elif [[ "$STATUS" == *"KernelWorkerStatus.ERROR"* ]]; then
              echo "âŒ Kernel Error"
              exit 1
            elif [[ "$STATUS" == *"KernelWorkerStatus.RUNNING"* || "$STATUS" == *"KernelWorkerStatus.QUEUED"* ]]; then
              echo "âœ… Kernel running"
            fi
            sleep 300
          done

      # Download Notebook Outputs
      - name: Download Notebook Outputs
        run: |
          KAGGLE_USERNAME="${{ steps.set_kaggle_creds.outputs.kaggle_username }}"
          kaggle kernels output $KAGGLE_USERNAME/video-editing-scheduler-notebook -p ./outputs

      # Copy Processed Videos
      - name: Copy Processed Videos to Local Folders
        run: |
          echo "ðŸ“ Copying processed videos from Kaggle outputs..."
          cp -r ./outputs/repo/REELS/* REELS/ 2>/dev/null || echo "No REELS files to copy"
          echo "âœ… Copy completed. Current contents:"
          ls -la REELS/ 2>/dev/null || echo "REELS folder empty"

      # Commit Results
      - name: Commit and Push Changes
        run: |
          git config --local user.name "github-actions"
          git config --local user.email "github-actions@github.com"
          git add --sparse REELS || echo "Nothing to add"
          git commit -m "Update reels after Kaggle GPU notebook run (Video ${{ needs.update-counter.outputs.video_number }})" || echo "No changes"
          git pull --rebase origin main || echo "No changes"
          git push || echo "No changes"

  rotate-kaggle:
    needs: run-on-kaggle
    runs-on: ubuntu-latest
    steps:
      # Checkout repository
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          repository: WildlifeAnimalDocumentaries/wildlife.animal.documentaries
          token: ${{ secrets.PRIVATE_REPO_TOKEN }}
          sparse-checkout: |
            kaggle_rotation.py
            kaggle_account_tracker.txt
          fetch-depth: 1

      # Pull latest changes
      - name: Pull Latest Changes
        run: git pull origin main

      # Set up Python
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12.9'

      # Rotate to next Kaggle account
      - name: Rotate Kaggle Account
        run: |
          echo "ðŸ”„ Rotating Kaggle account for next workflow run..."
          python3 kaggle_rotation.py
          NEXT_ACCOUNT=$(cat kaggle_account_tracker.txt)
          echo "âœ… Next workflow will use Kaggle account: $NEXT_ACCOUNT"

      # Commit rotation
      - name: Commit Kaggle Rotation
        run: |
          git config --local user.name "github-actions"
          git config --local user.email "github-actions@github.com"
          git add kaggle_account_tracker.txt
          git commit -m "Rotate Kaggle account tracker" || echo "No changes to commit"
          git push || echo "No changes to push"
